#!/bin/bash
# Remote Pipeline Manager - Runs services on SERVER, not locally
# This is the CORRECT way to run the pipeline

SERVER="reku631@89.169.108.8"
SSH_KEY="$HOME/reku631_nebius"
REMOTE_DIR="~/PipeLineServies"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

case "$1" in
    start)
        echo -e "${CYAN}Starting services on SERVER...${NC}"
        ssh -i "$SSH_KEY" "$SERVER" "cd $REMOTE_DIR && nohup ./start_all.sh > /tmp/pipeline.log 2>&1 &"
        echo -e "${GREEN}✓ Services started on server${NC}"
        echo -e "Check status with: ${CYAN}./Tools/remote-pipeline status${NC}"
        ;;

    stop)
        echo -e "${CYAN}Stopping services on SERVER...${NC}"
        ssh -i "$SSH_KEY" "$SERVER" "cd $REMOTE_DIR && ./stop_all.sh"
        echo -e "${GREEN}✓ Services stopped${NC}"
        ;;

    status)
        echo -e "${CYAN}Checking service status on SERVER...${NC}"
        ssh -i "$SSH_KEY" "$SERVER" "cd $REMOTE_DIR && ./check_status.sh"
        ;;

    logs)
        echo -e "${CYAN}Fetching logs from SERVER...${NC}"
        ssh -i "$SSH_KEY" "$SERVER" "tail -100 /tmp/pipeline.log"
        ;;

    tunnel)
        echo -e "${CYAN}Starting SSH tunnel...${NC}"
        echo -e "Run this in a separate terminal:"
        echo -e "${GREEN}ssh -i ~/reku631_nebius -L 19530:localhost:19530 -L 3000:localhost:3000 -L 8000:localhost:8000 -L 8060:localhost:8060 reku631@89.169.108.8${NC}"
        ;;

    *)
        echo "Remote Pipeline Manager"
        echo ""
        echo "Usage: $0 {start|stop|status|logs|tunnel}"
        echo ""
        echo "  start   - Start all services on SERVER"
        echo "  stop    - Stop all services on SERVER"
        echo "  status  - Check service status on SERVER"
        echo "  logs    - View logs from SERVER"
        echo "  tunnel  - Show SSH tunnel command"
        ;;
esac
