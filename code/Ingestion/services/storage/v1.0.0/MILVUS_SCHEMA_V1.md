# Milvus Collection Schema v1.0.0

**Version:** 1.0.0
**Date:** October 9, 2025
**Purpose:** Complete schema definition for Milvus vector database collections
**Total Fields:** 14

---

## üìä Complete Schema Overview

The Milvus collection stores **14 fields per chunk**:
- **9 Core Fields** (document metadata + stats)
- **1 Vector Field** (4096-dim dense embedding)
- **4 Metadata Fields** (AI-extracted via Metadata Service)

---

## üóÇÔ∏è Field Definitions

### Category 1: Core Fields (9 fields)

These fields are automatically generated by the Ingestion Pipeline.

```python
# Identifiers (3)
id: str                # Unique chunk ID (format: "{document_id}_chunk_{index}")
document_id: str       # Document identifier
chunk_index: int       # Chunk position in document (0-based)

# Content (1)
text: str              # Actual chunk text content

# Multi-tenancy (1)
tenant_id: str         # Tenant identifier (default: "default")

# Timestamps (2)
created_at: str        # ISO 8601 timestamp (e.g., "2025-10-09T14:23:45.123456")
updated_at: str        # ISO 8601 timestamp (e.g., "2025-10-09T14:23:45.123456")

# Statistics (2)
char_count: int        # Character count in text
token_count: int       # Token count (currently 0, future: actual tokenization)
```

### Category 2: Vector Field (1 field)

Generated by the Embeddings Service (port 8063).

```python
dense_vector: list[float]  # 4096-dimensional embedding vector
                           # Model: intfloat/e5-mistral-7b-instruct
                           # Normalized: True
```

### Category 3: Metadata Fields (4 fields)

Extracted by the Metadata Service (port 8062) using LLM Gateway (port 8065).

```python
keywords: str          # Comma-separated keywords (5-10)
                       # Example: "ITVAMS, vehicle tracking, GPS, fleet management"

topics: str            # Comma-separated topics (2-5)
                       # Example: "Fleet Management, GPS Technology, Transportation"

questions: str         # Semicolon-separated questions (2-5)
                       # Example: "What is ITVAMS?; What features does it provide?"

summary: str           # Brief summary (1-2 sentences)
                       # Example: "ITVAMS is a vehicle tracking system..."
```

---

## üèóÔ∏è Milvus Collection Creation

### Python Code (via pymilvus)

```python
from pymilvus import CollectionSchema, FieldSchema, DataType

# Define fields
fields = [
    # Core fields (9)
    FieldSchema(name="id", dtype=DataType.VARCHAR, max_length=255, is_primary=True),
    FieldSchema(name="document_id", dtype=DataType.VARCHAR, max_length=255),
    FieldSchema(name="chunk_index", dtype=DataType.INT64),
    FieldSchema(name="text", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="tenant_id", dtype=DataType.VARCHAR, max_length=255),
    FieldSchema(name="created_at", dtype=DataType.VARCHAR, max_length=50),
    FieldSchema(name="updated_at", dtype=DataType.VARCHAR, max_length=50),
    FieldSchema(name="char_count", dtype=DataType.INT64),
    FieldSchema(name="token_count", dtype=DataType.INT64),

    # Vector field (1)
    FieldSchema(name="dense_vector", dtype=DataType.FLOAT_VECTOR, dim=4096),

    # Metadata fields (4)
    FieldSchema(name="keywords", dtype=DataType.VARCHAR, max_length=2000),
    FieldSchema(name="topics", dtype=DataType.VARCHAR, max_length=2000),
    FieldSchema(name="questions", dtype=DataType.VARCHAR, max_length=2000),
    FieldSchema(name="summary", dtype=DataType.VARCHAR, max_length=2000)
]

# Create schema
schema = CollectionSchema(
    fields=fields,
    description="RAG collection with 14 fields (9 core + 1 vector + 4 metadata)"
)

# Create collection
from pymilvus import Collection
collection = Collection(
    name="my_collection",
    schema=schema,
    using='default'
)
```

---

## üìù Example Document Flow

### Input Document
```
Document ID: doc_001
Text: "The ITVAMS system provides vehicle tracking and management capabilities.
       It supports GPS monitoring, route optimization, and fleet analytics."
```

### Processing Pipeline

1. **Chunking Service** (port 8061): Splits into chunks
2. **Metadata Service** (port 8062): Extracts keywords, topics, questions, summary
3. **Embeddings Service** (port 8063): Generates 4096-dim vector
4. **Storage Service** (port 8064): Inserts into Milvus

### Stored Chunk in Milvus

```json
{
  "id": "doc_001_chunk_0",
  "document_id": "doc_001",
  "chunk_index": 0,
  "text": "The ITVAMS system provides vehicle tracking and management capabilities...",
  "tenant_id": "default",
  "created_at": "2025-10-09T14:23:45.123456",
  "updated_at": "2025-10-09T14:23:45.123456",
  "char_count": 145,
  "token_count": 0,

  "dense_vector": [0.023, -0.145, 0.892, ...],  // 4096 dimensions

  "keywords": "ITVAMS, vehicle tracking, GPS monitoring, fleet management, route optimization",
  "topics": "Fleet Management, GPS Technology, Transportation",
  "questions": "What is ITVAMS?; What features does it provide?; Who uses ITVAMS?",
  "summary": "ITVAMS is a vehicle tracking system with GPS monitoring and route optimization for fleet management."
}
```

---

## üîç Index Configuration

The Storage Service creates two indexes:

### 1. Vector Index (Dense Vector)
```python
index_params = {
    "metric_type": "IP",        # Inner Product (cosine similarity)
    "index_type": "IVF_FLAT",   # IVF index for fast search
    "params": {"nlist": 1024}   # Number of clusters
}

collection.create_index(
    field_name="dense_vector",
    index_params=index_params
)
```

### 2. Scalar Indexes (for filtering)
```python
# Index on tenant_id for multi-tenancy filtering
collection.create_index(field_name="tenant_id")

# Index on document_id for document-level operations
collection.create_index(field_name="document_id")
```

---

## üîé Query Examples

### 1. Vector Search with Metadata Filtering
```python
search_params = {
    "metric_type": "IP",
    "params": {"nprobe": 10}
}

results = collection.search(
    data=[query_vector],              # 4096-dim query vector
    anns_field="dense_vector",        # Search on dense_vector field
    param=search_params,
    limit=10,                         # Top 10 results
    expr='tenant_id == "default"',    # Filter by tenant
    output_fields=["text", "keywords", "topics", "summary", "char_count"]
)
```

### 2. Filter by Document ID
```python
results = collection.query(
    expr='document_id == "doc_001"',
    output_fields=["chunk_index", "text", "keywords", "char_count"]
)
```

### 3. Delete Document (All Chunks)
```python
collection.delete(expr='document_id == "doc_001"')
```

---

## üìê Field Size Limits

| Field | Max Length | Notes |
|-------|------------|-------|
| `id` | 255 chars | Format: `{document_id}_chunk_{index}` |
| `document_id` | 255 chars | User-defined |
| `text` | 65,535 chars | ~16k tokens max (practical limit) |
| `tenant_id` | 255 chars | Typically short (e.g., "tenant_001") |
| `created_at` / `updated_at` | 50 chars | ISO 8601 format |
| `keywords` | 2,000 chars | ~200-300 keywords max |
| `topics` | 2,000 chars | ~100-200 topics max |
| `questions` | 2,000 chars | ~10-20 questions max |
| `summary` | 2,000 chars | ~1-2 sentences recommended |

---

## üéØ Field Sources & Responsibilities

| Field | Generated By | Port | Notes |
|-------|-------------|------|-------|
| `id` | Ingestion API | 8060 | Format: `{document_id}_chunk_{index}` |
| `document_id` | User Input | - | Provided in API request |
| `chunk_index` | Chunking Service | 8061 | Sequential numbering |
| `text` | Chunking Service | 8061 | Actual chunk content |
| `tenant_id` | User Input | - | Provided in API request |
| `created_at` | Ingestion API | 8060 | ISO 8601 timestamp |
| `updated_at` | Ingestion API | 8060 | ISO 8601 timestamp |
| `char_count` | Ingestion API | 8060 | `len(text)` |
| `token_count` | Ingestion API | 8060 | Currently 0 (future: tokenizer) |
| `dense_vector` | Embeddings Service | 8063 | e5-mistral-7b-instruct (4096-dim) |
| `keywords` | Metadata Service | 8062 | Via LLM Gateway (8065) |
| `topics` | Metadata Service | 8062 | Via LLM Gateway (8065) |
| `questions` | Metadata Service | 8062 | Via LLM Gateway (8065) |
| `summary` | Metadata Service | 8062 | Via LLM Gateway (8065) |

---

## üîÑ Schema Evolution

### Current: v1.0.0 (14 fields)
- 9 core fields
- 1 dense vector field (4096-dim)
- 4 metadata fields

### Future: v2.0.0 (Potential additions)
- `sparse_vector`: BM25-style sparse embeddings for hybrid search
- `language`: Auto-detected language code
- `categories`: Hierarchical categorization
- `entities`: Named entity extraction
- Additional metadata fields as needed

---

## üì¶ Storage API Integration

The Storage Service (port 8064) handles all Milvus operations via REST API:

### Create Collection
```bash
POST http://localhost:8064/v1/collections
{
  "name": "my_collection",
  "dimension": 4096,
  "description": "RAG collection with 14 fields"
}
```

### Insert Chunks
```bash
POST http://localhost:8064/v1/insert
{
  "collection_name": "my_collection",
  "chunks": [
    {
      "id": "doc_001_chunk_0",
      "document_id": "doc_001",
      "chunk_index": 0,
      "text": "...",
      "tenant_id": "default",
      "created_at": "...",
      "updated_at": "...",
      "char_count": 145,
      "token_count": 0,
      "dense_vector": [...],
      "keywords": "...",
      "topics": "...",
      "questions": "...",
      "summary": "..."
    }
  ]
}
```

---

## ‚úÖ Validation Rules

1. **id**: Must be unique across collection
2. **document_id**: Required, max 255 chars
3. **chunk_index**: Must be >= 0, sequential within document
4. **text**: Required, min 1 char, max 65,535 chars
5. **tenant_id**: Required, default "default"
6. **created_at / updated_at**: ISO 8601 format required
7. **char_count**: Must equal `len(text)`
8. **token_count**: Currently 0, future: actual token count
9. **dense_vector**: Exactly 4096 dimensions, normalized
10. **keywords / topics / questions / summary**: Can be empty string if metadata extraction fails

---

## üè∑Ô∏è Use Cases

### 1. Multi-Tenant Search
Filter by `tenant_id` to isolate tenant data:
```python
expr='tenant_id == "tenant_acme"'
```

### 2. Document Management
- List all chunks: `expr='document_id == "doc_001"'`
- Delete document: `collection.delete(expr='document_id == "doc_001"')`
- Update document: Delete old chunks + insert new chunks

### 3. Metadata-Enhanced Search
Use `keywords`, `topics`, `summary` for:
- Pre-filtering before vector search
- Display in search results UI
- Faceted search / filtering

### 4. Analytics
Use stats fields for insights:
- `char_count`: Document size distribution
- `chunk_index`: Average chunks per document
- `created_at`: Ingestion timeline

---

**END OF SCHEMA DOCUMENTATION**
